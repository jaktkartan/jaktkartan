<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jaktkartan.se</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css" />
    <style>
        /* Anpassad CSS för att ändra zoomkontrollernas position */
        .leaflet-top.leaflet-left {
            top: 80px !important;
            left: 10px !important;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center; /* Centrera innehållet horisontellt */
            height: 100vh; /* Sätt höjden till fulla höjden av vyporten */
            margin: 0; /* Ta bort marginaler för att undvika onödig skrollning */
            overflow-x: hidden; /* Dölj horisontell skrollning */
        }
    </style>
</head>
<body>
    <!-- jaktkartan logo längst upp i vänstra hörnet med länk till jaktkartan.se -->
    <a href="http://www.jaktkartan.se" style="position: fixed; top: 15px; left: 10px; z-index: 9999;">
        <img src="bilder/ikon3.png" alt="Jaktkartan.se" style="width: 50px; height: auto;">
    </a>

    <div id="info-panel">
        <div id="accuracy">Lägesnoggrannhet: Unknown</div>
        <div id="sunrise-sunset">
            <img id="sunrise-icon" src="https://raw.githubusercontent.com/timothylevin/Testmiljo/main/bilder/soluppgang.png" alt="Sunrise Icon" style="height: 24px;">
            <span id="sunrise"></span>
            <img id="sunset-icon" src="https://raw.githubusercontent.com/timothylevin/Testmiljo/main/bilder/solnedgang.png" alt="Sunset Icon" style="height: 24px;">
            <span id="sunset"></span>
            <div class="expand-toggle" onclick="togglePanel()">Väderprognos <span class="arrow">&#9660;</span></div>
            <div id="weather-info" style="display: none;">
                <div id="weather-text">Laddar väder...</div>
            </div>
        </div>
    </div>

    <div id="map" style="width: 100%; height: 100%;"></div>
    
    <div id="bottom-panel">
        <button class="panel-button" onclick="openTab('tab1', 'bottom_panel/Upptack/Upptack.html')"><img src="https://raw.githubusercontent.com/timothylevin/Testmiljo/main/bilder/upptack.png" alt="Upptäck"></button>
        <button class="panel-button" onclick="openTab('tab2', 'bottom_panel/Kartor/Kartor.html')"><img src="https://raw.githubusercontent.com/timothylevin/Testmiljo/main/bilder/kartor.png" alt="Kartor"></button>
        <button class="panel-button" onclick="openTab('tab3', 'bottom_panel/Jaktbart_idag/Jaktbart_idag.html')"><img src="https://raw.githubusercontent.com/timothylevin/Testmiljo/main/bilder/jaktbart idag.png" alt="Jaktbart idag"></button>
        <button class="panel-button" onclick="openTab('tab4', '')"><img src="https://raw.githubusercontent.com/timothylevin/Testmiljo/main/bilder/kaliberkrav.png" alt="Kaliberkrav"></button>
        <button class="panel-button" onclick="openTab('tab5', 'bottom_panel/Jaktkollen/Jaktkollen.html')"><img src="https://raw.githubusercontent.com/timothylevin/Testmiljo/main/bilder/jaktkollen.png" alt="Jaktkollen"></button>
    </div>

    <div id="tab-content" style="display:none;">
        <div id="tab1" class="tab-pane"></div>
        <div id="tab2" class="tab-pane"></div>
        <div id="tab3" class="tab-pane"></div>
        <div id="tab4" class="tab-pane"></div>
        <div id="tab5" class="tab-pane"></div>
    </div>
    
    <div id="popup-panel">
        <div id="popup-panel-content">
            <!-- Innehåll i panelen uppdateras dynamiskt här -->
        </div>
    </div>

    <script src="https://unpkg.com/suncalc/suncalc.js"></script>
    <script src="vaderprognos.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="bottom_panel/Upptack/Upptack_flikbeteende.js"></script>
    <script src="bottom_panel/Kartor/Kartor_flikbeteende.js"></script>
    <script src="bottom_panel/Jaktkollen/Jaktkollen_flikbeteende.js"></script>
    <script src="bottom_panel/Upptack/Upptack_geojsonHandler.js"></script>
    <script src="bottom_panel/Kartor/Kartor_geojsonHandler.js"></script>
    <script src="tabHandler.js"></script>

    <script>
        // Declare map as a global variable
        var map;
        var userGeoLocation = {
            latitude: null,
            longitude: null,
            accuracy: null
        };

        document.addEventListener("DOMContentLoaded", function() {
            console.log("Initializing map...");

            map = L.map('map', {
                zoomControl: false // Ta bort standardzoomkontrollerna
            }).setView([62.0, 15.0], 5);

            L.control.zoom({
                position: 'topleft' // Ändra positionen på zoomkontrollerna
            }).addTo(map);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            var accuracyCircle;
            var userMarker;
            var pulsingDotMarker;
            var sunriseIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/timothylevin/Testmiljo/main/sunrise.png',
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, 0],
            });
            var sunsetIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/timothylevin/Testmiljo/main/sunset.png',
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, 0],
            });

            function createPulsingCircle(lat, lon) {
                var divIcon = L.divIcon({
                    className: 'pulsing-circle',
                    iconSize: [12, 12],
                    html: `<div class="pulsing-dot" data-lat="${lat}" data-lon="${lon}"></div>`
                });
                return L.marker([lat, lon], { icon: divIcon }).addTo(map);
            }

            function updateUserPosition(lat, lon, accuracy) {
                console.log(`Updating user position: ${lat}, ${lon}, accuracy: ${accuracy}`);

                userGeoLocation.latitude = lat;
                userGeoLocation.longitude = lon;
                userGeoLocation.accuracy = accuracy;

                var accuracyInfo = document.getElementById('accuracy');
                accuracyInfo.innerHTML = "Lägesnoggrannhet: " + accuracy + " meters";

                if (!accuracyCircle) {
                    accuracyCircle = L.circle([lat, lon], {
                        radius: accuracy,
                        fillColor: 'green',
                        fillOpacity: 0.5,
                        stroke: false
                    }).addTo(map);
                } else {
                    accuracyCircle.setLatLng([lat, lon]).setRadius(accuracy).setStyle({fillColor: 'green'});
                }

                if (!userMarker) {
                    userMarker = L.marker([lat, lon], { icon: L.divIcon({className: 'transparent-marker-icon'}) }).addTo(map);
                } else {
                    userMarker.setLatLng([lat, lon]);
                }

                if (!pulsingDotMarker) {
                                        pulsingDotMarker = createPulsingCircle(lat, lon);
                } else {
                    pulsingDotMarker.setLatLng([lat, lon]);
                }

                var times = SunCalc.getTimes(new Date(), lat, lon);
                var sunrise = times.sunrise ? times.sunrise.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Unknown';
                var sunset = times.sunset ? times.sunset.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Unknown';
                var sunriseSpan = document.getElementById('sunrise');
                var sunsetSpan = document.getElementById('sunset');

                sunriseSpan.innerHTML = sunrise;
                sunsetSpan.innerHTML = sunset;

            function getPositionFromIP() {
                axios.get('https://ipinfo.io/json?token=c57bc38a5d7e2c')
                    .then(function (response) {
                        var loc = response.data.loc.split(',');
                        var lat = parseFloat(loc[0]);
                        var lon = parseFloat(loc[1]);
                        updateUserPosition(lat, lon, "Unknown");
                    })
                    .catch(function (error) {
                        console.log("IP Geolocation failed: " + error.message);
                    });
            }

            function handleGeolocation(position) {
                var lat = position.coords.latitude;
                var lon = position.coords.longitude;
                var accuracy = position.coords.accuracy;
                updateUserPosition(lat, lon, accuracy.toFixed(2));
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                        handleGeolocation(position);
                    },
                    function (error) {
                        console.log("Geolocation failed: " + error.message);
                        getPositionFromIP();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );

                navigator.geolocation.watchPosition(
                    function (position) {
                        handleGeolocation(position);
                    },
                    function (error) {
                        console.log("Geolocation failed: " + error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                map.setView([62.0, 15.0], 5);
            }

            // Funktion för att visa panelen när användaren trycker på ett geojson-objekt
            function showPopupPanel() {
                var panel = document.getElementById('popup-panel');
                panel.style.display = 'block';
            }

            // Funktion för att dölja panelen
            function hidePopupPanel() {
                var panel = document.getElementById('popup-panel');
                panel.style.display = 'none';
            }

            // Funktion för att uppdatera panelens innehåll baserat på geojson-objektets egenskaper
            function updatePopupPanelContent(properties) {
                var panelContent = document.getElementById('popup-panel-content');
                var content = '';

                for (var key in properties) {
                    if (properties.hasOwnProperty(key)) {
                        var value = properties[key];
                        content += '<p><strong>' + key + ':</strong> ' + value + '</p>';
                    }
                }

                panelContent.innerHTML = content;
            }

            // Exempel på anrop till funktionen (anpassa efter behov)
            function addClickHandlerToLayer(layer) {
                layer.on('click', function (e) {
                    showPopupPanel();
                    updatePopupPanelContent(e.target.feature.properties);
                });
            }
        });
    </script>
    <script src="popupHandler.js"></script>
 
    </script>
</body>
</html>

