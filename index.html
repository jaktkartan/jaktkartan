<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jaktkartan.se</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css" />
    <script src="https://unpkg.com/suncalc/suncalc.js"></script>
    <script src="vaderprognos.js"></script>
    <style>
        /* Anpassad CSS för att ändra zoomkontrollernas position */
        .leaflet-top.leaflet-left {
            top: 80px !important;
            left: 10px !important;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center; /* Centrera innehållet horisontellt */
            height: 100vh; /* Sätt höjden till fulla höjden av vyporten */
            margin: 0; /* Ta bort marginaler för att undvika onödig skrollning */
            overflow-x: hidden; /* Dölj horisontell skrollning */
        }
    </style>
</head>
<body>
    <div id="info-panel">
        <div id="accuracy">Lägesnoggrannhet: Unknown</div>
        <div id="sunrise-sunset">
            <img id="sunrise-icon" src="https://raw.githubusercontent.com/timothylevin/Testmiljo/main/sunrise.png" alt="Sunrise Icon" style="height: 24px;">
            <span id="sunrise"></span>
            <img id="sunset-icon" src="https://raw.githubusercontent.com/timothylevin/Testmiljo/main/sunset.png" alt="Sunset Icon" style="height: 24px;">
            <span id="sunset"></span>
            <div class="expand-toggle" onclick="togglePanel()">Väderprognos <span class="arrow">&#9660;</span></div>
            <div id="weather-info" style="display: none;">
                <div id="weather-text">Laddar väder...</div>
            </div>
        </div>
    </div>
    <div id="map"></div>
    
    <div id="bottom-panel">
        <button class="panel-button" onclick="openTab('tab1', 'bottom_panel/upptack.html')"><img src="https://raw.githubusercontent.com/timothylevin/Testmiljo/main/bilder/upptack.png" alt="Upptäck"></button>
        <button class="panel-button" onclick="openTab('tab2', 'bottom_panel/kartor.html')"><img src="https://raw.githubusercontent.com/timothylevin/Testmiljo/main/bilder/kartor.png" alt="Kartor"></button>
        <button class="panel-button" onclick="openTab('tab3', 'bottom_panel/jaktbart_idag.html')"><img src="https://raw.githubusercontent.com/timothylevin/Testmiljo/main/bilder/jaktbart idag.png" alt="Jaktbart idag"></button>
        <button class="panel-button" onclick="openTab('tab4', 'bottom_panel/kaliberkrav.html')"><img src="https://raw.githubusercontent.com/timothylevin/Testmiljo/main/bilder/kaliberkrav.png" alt="Ammunition"></button>
        <button class="panel-button" onclick="openTab('tab5', 'bottom_panel/jaktkollen.html')"><img src="https://raw.githubusercontent.com/timothylevin/Testmiljo/main/bilder/jaktkollen.png" alt="Jaktkollen"></button>
    </div>
    <div id="tab-content" style="display:none;">
        <div id="tab1" class="tab-pane"></div>
        <div id="tab2" class="tab-pane"></div>
        <div id="tab3" class="tab-pane"></div>
        <div id="tab4" class="tab-pane"></div>
        <div id="tab5" class="tab-pane"></div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        function togglePanel() {
            console.log("Toggling weather panel...");
            var weatherInfo = document.getElementById('weather-info');
            if (weatherInfo.style.display === 'none') {
                console.log("Showing weather panel...");
                weatherInfo.style.display = 'block';
                navigator.geolocation.getCurrentPosition(function (position) {
                    console.log("Getting current position...");
                    var latitude = position.coords.latitude;
                    var longitude = position.coords.longitude;
                    console.log("Current position:", latitude, longitude);
                    getWeatherForecast(latitude, longitude);
                });
            } else {
                console.log("Hiding weather panel...");
                weatherInfo.style.display = 'none';
            }
        }

        function openTab(tabId, filePath) {
            var tabContent = document.getElementById('tab-content');
            var tabs = document.getElementsByClassName('tab-pane');

            for (var i = 0; i < tabs.length; i++) {
                tabs[i].style.display = 'none';
            }

            var activeTab = document.getElementById(tabId);
            activeTab.style.display = 'block';

            tabContent.style.display = 'block';

            // Ladda innehåll från extern fil
            axios.get(filePath)
                .then(function (response) {
                    activeTab.innerHTML = response.data;
                })
                .catch(function (error) {
                    console.log("Error loading tab content: " + error.message);
                });
        }

        function closeTabContent() {
            var tabContent = document.getElementById('tab-content');
            tabContent.style.display = 'none';
        }

        // Close the tab content when clicking outside of it
        document.addEventListener('click', function(event) {
            var tabContent = document.getElementById('tab-content');
            if (!tabContent.contains(event.target) && !event.target.matches('.panel-button img')) {
                closeTabContent();
            }
        });

        document.addEventListener("DOMContentLoaded", function() {
            console.log("Initializing map...");

            var map = L.map('map', {
                zoomControl: false // Ta bort standardzoomkontrollerna
            }).setView([62.0, 15.0], 5);

            L.control.zoom({
                position: 'topleft' // Ändra positionen på zoomkontrollerna
            }).addTo(map);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            var accuracyCircle;
            var userMarker;
            var pulsingDotMarker;
            var sunriseIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/timothylevin/Testmiljo/main/sunrise.png',
                iconSize: [24, 24]
            });

            var sunsetIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/timothylevin/Testmiljo/main/sunset.png',
                iconSize: [24, 24]
            });

            map.on('locationfound', function (e) {
                var radius = e.accuracy;
                var location = e.latlng;

                if (accuracyCircle) {
                    map.removeLayer(accuracyCircle);
                }

                if (userMarker) {
                    map.removeLayer(userMarker);
                }

                if (pulsingDotMarker) {
                    map.removeLayer(pulsingDotMarker);
                }

                accuracyCircle = L.circle(location, radius, {
                    color: 'blue',
                    fillColor: '#3388ff',
                    fillOpacity: 0.2
                }).addTo(map);

                userMarker = L.marker(location).addTo(map);

                var pulsingDot = L.divIcon({
                    className: 'pulsing-dot',
                    iconSize: [12, 12],
                    html: '<div class="dot"></div><div class="pulse"></div>'
                });

                pulsingDotMarker = L.marker(location, { icon: pulsingDot }).addTo(map);

                var accuracyElement = document.getElementById('accuracy');
                accuracyElement.textContent = 'Lägesnoggrannhet: ' + Math.round(radius) + ' meter';
            });

            map.on('locationerror', function (e) {
                console.log(e.message);
            });

            map.locate({ setView: true, maxZoom: 16, watch: true });
        });

        function getWeatherForecast(latitude, longitude) {
            console.log("Fetching weather forecast for:", latitude, longitude);

            var apiKey = '47a50669a0e799cdbef2d496a6b6f748';
            var weatherUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${apiKey}&units=metric`;

            axios.get(weatherUrl)
                .then(function (response) {
                    var data = response.data;
                    console.log("Weather data received:", data);

                    var weatherText = document.getElementById('weather-text');
                    weatherText.innerHTML = `Väderprognos: ${data.weather[0].description}, Temperatur: ${data.main.temp} °C, Vindhastighet: ${data.wind.speed} m/s`;

                    // Beräkna soluppgång och solnedgång
                    var times = SunCalc.getTimes(new Date(), latitude, longitude);
                    var sunrise = times.sunrise;
                    var sunset = times.sunset;

                    document.getElementById('sunrise').textContent = sunrise.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    document.getElementById('sunset').textContent = sunset.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    // Rensa tidigare markörer om de finns
                    if (sunriseMarker) {
                        map.removeLayer(sunriseMarker);
                    }
                    if (sunsetMarker) {
                        map.removeLayer(sunsetMarker);
                    }

                    // Lägg till markörer på kartan
                    sunriseMarker = L.marker([latitude, longitude], { icon: sunriseIcon }).addTo(map);
                    sunsetMarker = L.marker([latitude, longitude], { icon: sunsetIcon }).addTo(map);

                    console.log("Sunrise marker added at:", sunriseMarker.getLatLng());
                    console.log("Sunset marker added at:", sunsetMarker.getLatLng());
                })
                .catch(function (error) {
                    console.log("Error fetching weather data:", error);
                    var weatherText = document.getElementById('weather-text');
                    weatherText.innerHTML = "Kunde inte hämta väderdata.";
                });
        }
    </script>
</body>
</html>
